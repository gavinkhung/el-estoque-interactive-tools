import { Deck } from '@deck.gl/core';
import { ScatterplotLayer, TextLayer } from '@deck.gl/layers';
import mapboxgl from 'mapbox-gl';

mapboxgl.accessToken = process.env.MAPBOX_ACCESS_TOKEN;

const data = [
  {
    zipcode: 94022,
    lat: 37.36556,
    long: -122.14849,
    cases: 354,
    population: 19378,
    rate: 1827,
    city: 'Los Altos',
  },
  {
    zipcode: 94024,
    lat: 37.35515,
    long: -122.11096,
    cases: 391,
    population: 23961,
    rate: 1632,
    city: 'Los Altos',
  },
  {
    zipcode: 94040,
    lat: 37.38476,
    long: -122.08771,
    cases: 1184,
    population: 35845,
    rate: 3303,
    city: 'Mountain View',
  },
  {
    zipcode: 94041,
    lat: 37.38802,
    long: -122.07431,
    cases: 499,
    population: 14394,
    rate: 3467,
    city: 'Mountain View',
  },
  {
    zipcode: 94043,
    lat: 37.41916,
    long: -122.07541,
    cases: 855,
    population: 31488,
    rate: 2715,
    city: 'Mountain View',
  },
  {
    zipcode: 94085,
    lat: 37.3886,
    long: -122.01678,
    cases: 1021,
    population: 23612,
    rate: 4324,
    city: 'Sunnyvale',
  },
  {
    zipcode: 94086,
    lat: 37.36965,
    long: -122.02421,
    cases: 1612,
    population: 49630,
    rate: 3248,
    city: 'Sunnyvale',
  },
  {
    zipcode: 94087,
    lat: 37.35351,
    long: -122.03048,
    cases: 1153,
    population: 57219,
    rate: 2015,
    city: 'Sunnyvale',
  },
  {
    zipcode: 94089,
    lat: 37.42519,
    long: -122.01725,
    cases: 896,
    population: 22313,
    rate: 4016,
    city: 'Sunnyvale',
  },
  {
    zipcode: 94301,
    lat: 37.44296,
    long: -122.1512,
    cases: 398,
    population: 17191,
    rate: 2315,
    city: 'Palo Alto',
  },
  {
    zipcode: 94304,
    lat: 37.40431,
    long: -122.16727,
    cases: 114,
    population: 3902,
    rate: 2922,
    city: 'Palo Alto',
  },
  {
    zipcode: 94305,
    lat: 37.42399,
    long: -122.1676,
    cases: 129,
    population: 15730,
    rate: 820,
    city: 'Stanford Palo Alto',
  },
  {
    zipcode: 94306,
    lat: 37.41185,
    long: -122.1295,
    cases: 508,
    population: 27549,
    rate: 1844,
    city: 'Palo Alto',
  },
  {
    zipcode: 95002,
    lat: 37.44099,
    long: -121.99057,
    cases: 166,
    population: 2146,
    rate: 7735,
    city: 'Alviso',
  },
  {
    zipcode: 95008,
    lat: 37.27902,
    long: -121.95669,
    cases: 1721,
    population: 46513,
    rate: 3700,
    city: 'Campbell',
  },
  {
    zipcode: 95013,
    lat: 37.20834,
    long: -121.75542,
    cases: 0,
    population: 77,
    rate: 0,
    city: 'Coyote',
  },
  {
    zipcode: 95014,
    lat: 37.29426,
    long: -122.09444,
    cases: 734,
    population: 62430,
    rate: 1176,
    city: 'Cupertino Monte Vista Permanente',
  },
  {
    zipcode: 95020,
    lat: 37.02072,
    long: -121.57235,
    cases: 6548,
    population: 63852,
    rate: 10255,
    city: 'Gilroy',
  },
  {
    zipcode: 95030,
    lat: 37.22607,
    long: -121.98892,
    cases: 320,
    population: 13288,
    rate: 2408,
    city: 'Los Gatos Monte Sereno',
  },
  {
    zipcode: 95032,
    lat: 37.21874,
    long: -121.92945,
    cases: 666,
    population: 26281,
    rate: 2534,
    city: 'Los Gatos',
  },
  {
    zipcode: 95035,
    lat: 37.42204,
    long: -121.81659,
    cases: 3076,
    population: 77562,
    rate: 3966,
    city: 'Milpitas',
  },
  {
    zipcode: 95037,
    lat: 37.16808,
    long: -121.62704,
    cases: 3006,
    population: 51652,
    rate: 5820,
    city: 'Morgan Hill',
  },
  {
    zipcode: 95046,
    lat: 37.0956,
    long: -121.60453,
    cases: 556,
    population: 6025,
    rate: 9228,
    city: 'San Martin',
  },
  {
    zipcode: 95050,
    lat: 37.35148,
    long: -121.95082,
    cases: 1765,
    population: 39452,
    rate: 4474,
    city: 'Santa Clara',
  },
  {
    zipcode: 95051,
    lat: 37.35037,
    long: -121.98475,
    cases: 1786,
    population: 58123,
    rate: 3073,
    city: 'Santa Clara',
  },
  {
    zipcode: 95053,
    lat: 37.34946,
    long: -121.93757,
    cases: 0,
    population: 3678,
    rate: 0,
    city: 'Santa Clara',
  },
  {
    zipcode: 95054,
    lat: 37.39631,
    long: -121.9614,
    cases: 969,
    population: 24264,
    rate: 3994,
    city: 'Santa Clara',
  },
  {
    zipcode: 95070,
    lat: 37.25377,
    long: -122.05115,
    cases: 529,
    population: 31308,
    rate: 1690,
    city: 'Saratoga',
  },
  {
    zipcode: 95110,
    lat: 37.34217,
    long: -121.90677,
    cases: 2026,
    population: 20203,
    rate: 10028,
    city: 'San Jose',
  },
  {
    zipcode: 95111,
    lat: 37.28204,
    long: -121.8321,
    cases: 6214,
    population: 62392,
    rate: 9960,
    city: 'San Jose',
  },
  {
    zipcode: 95112,
    lat: 37.34154,
    long: -121.88182,
    cases: 4253,
    population: 61060,
    rate: 6965,
    city: 'San Jose',
  },
  {
    zipcode: 95113,
    lat: 37.33406,
    long: -121.89207,
    cases: 235,
    population: 1939,
    rate: 12120,
    city: 'San Jose',
  },
  {
    zipcode: 95116,
    lat: 37.34993,
    long: -121.8507,
    cases: 6105,
    population: 56481,
    rate: 10809,
    city: 'San Jose',
  },
  {
    zipcode: 95117,
    lat: 37.31268,
    long: -121.96578,
    cases: 2070,
    population: 29592,
    rate: 6995,
    city: 'San Jose',
  },
  {
    zipcode: 95118,
    lat: 37.25549,
    long: -121.88948,
    cases: 1456,
    population: 32560,
    rate: 4472,
    city: 'San Jose',
  },
  {
    zipcode: 95119,
    lat: 37.22976,
    long: -121.78637,
    cases: 517,
    population: 10472,
    rate: 4937,
    city: 'San Jose',
  },
  {
    zipcode: 95120,
    lat: 37.19268,
    long: -121.83411,
    cases: 771,
    population: 37774,
    rate: 2041,
    city: 'San Jose',
  },
  {
    zipcode: 95121,
    lat: 37.30317,
    long: -121.80773,
    cases: 3015,
    population: 38102,
    rate: 7913,
    city: 'San Jose',
  },
  {
    zipcode: 95122,
    lat: 37.33053,
    long: -121.83823,
    cases: 7300,
    population: 57780,
    rate: 12634,
    city: 'San Jose',
  },
  {
    zipcode: 95123,
    lat: 37.24071,
    long: -121.82688,
    cases: 4029,
    population: 67186,
    rate: 5997,
    city: 'San Jose',
  },
  {
    zipcode: 95124,
    lat: 37.25545,
    long: -121.92535,
    cases: 1474,
    population: 51170,
    rate: 2881,
    city: 'San Jose',
  },
  {
    zipcode: 95125,
    lat: 37.29722,
    long: -121.8951,
    cases: 2574,
    population: 53574,
    rate: 4805,
    city: 'San Jose',
  },
  {
    zipcode: 95126,
    lat: 37.32414,
    long: -121.91501,
    cases: 2048,
    population: 35988,
    rate: 5691,
    city: 'San Jose',
  },
  {
    zipcode: 95127,
    lat: 37.37384,
    long: -121.79316,
    cases: 6466,
    population: 65686,
    rate: 9844,
    city: 'San Jose',
  },
  {
    zipcode: 95128,
    lat: 37.31628,
    long: -121.93639,
    cases: 2236,
    population: 37665,
    rate: 5937,
    city: 'San Jose',
  },
  {
    zipcode: 95129,
    lat: 37.3075,
    long: -122.00223,
    cases: 915,
    population: 39828,
    rate: 2297,
    city: 'San Jose',
  },
  {
    zipcode: 95130,
    lat: 37.28516,
    long: -121.97782,
    cases: 444,
    population: 14863,
    rate: 2987,
    city: 'San Jose',
  },
  {
    zipcode: 95131,
    lat: 37.38745,
    long: -121.90226,
    cases: 1309,
    population: 31170,
    rate: 4200,
    city: 'San Jose',
  },
  {
    zipcode: 95132,
    lat: 37.40898,
    long: -121.8279,
    cases: 1733,
    population: 41844,
    rate: 4142,
    city: 'San Jose',
  },
  {
    zipcode: 95133,
    lat: 37.37164,
    long: -121.86119,
    cases: 1846,
    population: 28726,
    rate: 6426,
    city: 'San Jose',
  },
  {
    zipcode: 95134,
    lat: 37.42481,
    long: -121.946,
    cases: 747,
    population: 27224,
    rate: 2744,
    city: 'San Jose',
  },
  {
    zipcode: 95135,
    lat: 37.27582,
    long: -121.71464,
    cases: 562,
    population: 22358,
    rate: 2514,
    city: 'San Jose',
  },
  {
    zipcode: 95136,
    lat: 37.27248,
    long: -121.84347,
    cases: 2785,
    population: 47599,
    rate: 5851,
    city: 'San Jose',
  },
  {
    zipcode: 95138,
    lat: 37.24821,
    long: -121.73568,
    cases: 871,
    population: 20766,
    rate: 4194,
    city: 'San Jose',
  },
  {
    zipcode: 95139,
    lat: 37.22472,
    long: -121.76298,
    cases: 300,
    population: 7293,
    rate: 4114,
    city: 'San Jose',
  },
  {
    zipcode: 95140,
    lat: 37.36817,
    long: -121.68528,
    cases: 0,
    population: 115,
    rate: 0,
    city: 'Mount Hamilton San Jose',
  },
  {
    zipcode: 95148,
    lat: 37.3328,
    long: -121.77142,
    cases: 2896,
    population: 48854,
    rate: 5928,
    city: 'San Jose',
  },
];

const INITIAL_VIEW_STATE = {
  latitude: 37.3,
  longitude: -121.9,
  zoom: 9.75,
  minZoom: 9,
  maxZoom: 11,
  maxPitch: 5,
  pitch: 0,
  bearing: 0,
};

const MAP_STYLE =
  'https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json';

function getTooltip({ object }) {
  return (
    object &&
    `\
      City: ${object.city}
      Zipcode: ${object.zipcode}
      Population: ${object.population}
      COVID-19 Cases: ${object.cases}
      COVID-19 Case Rate: ${object.rate / 1000}%
      `
  );
}

const map = new mapboxgl.Map({
  container: 'map',
  style: MAP_STYLE,
  // Note: deck.gl will be in charge of interaction and event handling
  interactive: true,
  center: [INITIAL_VIEW_STATE.longitude, INITIAL_VIEW_STATE.latitude],
  zoom: INITIAL_VIEW_STATE.zoom,
  bearing: INITIAL_VIEW_STATE.bearing,
  pitch: INITIAL_VIEW_STATE.pitch,
});

export const deck = new Deck({
  canvas: 'deck-canvas',
  width: '100%',
  height: '100%',
  initialViewState: INITIAL_VIEW_STATE,
  controller: true,
  onViewStateChange: ({ viewState }) => {
    map.jumpTo({
      center: [viewState.longitude, viewState.latitude],
      zoom: viewState.zoom,
      bearing: viewState.bearing,
      pitch: viewState.pitch,
    });
  },
  layers: [
    new ScatterplotLayer({
      id: 'covid-santa-clara-visualization',
      data: data,
      opacity: 0.5,
      radiusScale: 100,
      radiusMinPixels: 1,
      wrapLongitude: true,

      getPosition: (d) => [d.long, d.lat],
      getRadius: (d) => Math.max(5, d.cases / 250),
      getFillColor: (d) => {
        const r = Math.max(d.cases / 300, 0);
        return [255 - r * 15, r * 5, r * 10];
      },
      onHover: ({ object, x, y }) => {
        const el = document.getElementById('tooltip');
        if (object) {
          const { city, zipcode, cases, population, rate } = object;
          el.innerHTML = `<h2>${city} ${zipcode}</h2><h3>Population: ${population}</h3><h3>COVID-19 Cases: ${cases}</h3><h3>COVID-19 Case Rate: ${
            rate / 1000
          }%</h3>`;
          el.style.display = 'block';
          el.style.opacity = 0.9;
          el.style.left = x + 'px';
          el.style.top = y + 'px';
        } else {
          el.style.opacity = 0.0;
        }
      },

      pickable: true,
    }),
    // new TextLayer({
    //   id: 'text-layer',
    //   data,
    //   pickable: true,
    //   getPosition: (d) => [d.long, d.lat],
    //   getText: (d) => d.city,
    //   getSize: 8,
    //   getAngle: 0,
    //   getTextAnchor: 'middle',
    //   getAlignmentBaseline: 'center',
    // }),
  ],
});
